<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auth System</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f7f9fc;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 400px;
            margin: 40px auto;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
        }

        .header h1 {
            color: #4285f4;
            margin-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }

        .btn {
            display: block;
            width: 100%;
            padding: 12px;
            background-color: #4285f4;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            text-align: center;
            transition: background-color 0.3s;
        }

        .btn:hover {
            background-color: #3367d6;
        }

        .alert {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .form-footer {
            text-align: center;
            margin-top: 20px;
            font-size: 14px;
        }

        .form-footer a {
            color: #4285f4;
            text-decoration: none;
        }

        .form-footer a:hover {
            text-decoration: underline;
        }

        .profile {
            padding: 20px;
        }

        .profile-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .profile-info {
            margin-bottom: 20px;
        }

        .profile-info p {
            margin-bottom: 10px;
        }

        .profile-info strong {
            font-weight: 600;
            width: 120px;
            display: inline-block;
        }

        .hidden {
            display: none;
        }

        .navbar {
            background-color: #4285f4;
            padding: 10px 20px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .navbar .brand {
            font-size: 20px;
            font-weight: bold;
        }

        .navbar .nav-links a {
            color: white;
            text-decoration: none;
            margin-left: 15px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="navbar">
        <div class="brand">Auth System</div>
        <div class="nav-links" id="navLinks">
            <a href="#" id="homeLink">Home</a>
            <a href="#" id="profileLink" class="hidden">Profile</a>
            <a href="#" id="loginLink">Login</a>
            <a href="#" id="registerLink">Register</a>
            <a href="#" id="logoutLink" class="hidden">Logout</a>
        </div>
    </div>

    <div class="container" id="homeContainer">
        <div class="header">
            <h1>Welcome to Auth System</h1>
            <p>Please login or register to continue</p>
        </div>
    </div>

    <div class="container hidden" id="loginContainer">
        <div class="header">
            <h1>Login</h1>
            <p>Enter your credentials to access your account</p>
        </div>
        <div id="loginAlert" class="alert hidden"></div>
        <form id="loginForm">
            <div class="form-group">
                <label for="loginEmail">Email</label>
                <input type="email" id="loginEmail" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="loginPassword">Password</label>
                <input type="password" id="loginPassword" class="form-control" required>
            </div>
            <button type="submit" class="btn">Login</button>
        </form>
        <div class="form-footer">
            <p>Don't have an account? <a href="#" id="goToRegister">Register</a></p>
            <p><a href="#" id="goToResetRequest">Forgot password?</a></p>
        </div>
    </div>

    <div class="container hidden" id="registerContainer">
        <div class="header">
            <h1>Register</h1>
            <p>Create a new account</p>
        </div>
        <div id="registerAlert" class="alert hidden"></div>
        <form id="registerForm">
            <div class="form-group">
                <label for="registerUsername">Username</label>
                <input type="text" id="registerUsername" class="form-control" minlength="3" required>
            </div>
            <div class="form-group">
                <label for="registerEmail">Email</label>
                <input type="email" id="registerEmail" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="registerPassword">Password</label>
                <input type="password" id="registerPassword" class="form-control" minlength="8" required>
            </div>
            <div class="form-group">
                <label for="registerConfirmPassword">Confirm Password</label>
                <input type="password" id="registerConfirmPassword" class="form-control" required>
            </div>
            <button type="submit" class="btn">Register</button>
        </form>
        <div class="form-footer">
            <p>Already have an account? <a href="#" id="goToLogin">Login</a></p>
        </div>
    </div>

    <div class="container hidden" id="resetRequestContainer">
        <div class="header">
            <h1>Reset Password</h1>
            <p>Enter your email to receive a password reset link</p>
        </div>
        <div id="resetRequestAlert" class="alert hidden"></div>
        <form id="resetRequestForm">
            <div class="form-group">
                <label for="resetEmail">Email</label>
                <input type="email" id="resetEmail" class="form-control" required>
            </div>
            <button type="submit" class="btn">Send Reset Link</button>
        </form>
        <div class="form-footer">
            <p><a href="#" id="backToLogin">Back to Login</a></p>
        </div>
    </div>

    <div class="container hidden" id="resetPasswordContainer">
        <div class="header">
            <h1>Set New Password</h1>
            <p>Enter your new password</p>
        </div>
        <div id="resetPasswordAlert" class="alert hidden"></div>
        <form id="resetPasswordForm">
            <input type="hidden" id="resetToken">
            <div class="form-group">
                <label for="newPassword">New Password</label>
                <input type="password" id="newPassword" class="form-control" minlength="8" required>
            </div>
            <div class="form-group">
                <label for="confirmNewPassword">Confirm New Password</label>
                <input type="password" id="confirmNewPassword" class="form-control" required>
            </div>
            <button type="submit" class="btn">Reset Password</button>
        </form>
    </div>

    <div class="container hidden" id="profileContainer">
        <div class="profile-header">
            <h1>Profile</h1>
        </div>
        <div id="profileAlert" class="alert hidden"></div>
        <div class="profile-info" id="profileInfo">
            <p><strong>Username:</strong> <span id="profileUsername"></span></p>
            <p><strong>Email:</strong> <span id="profileEmail"></span></p>
            <p><strong>Joined:</strong> <span id="profileCreatedAt"></span></p>
        </div>
        <div class="header">
            <h2>Update Profile</h2>
        </div>
        <form id="updateProfileForm">
            <div class="form-group">
                <label for="updateUsername">Username</label>
                <input type="text" id="updateUsername" class="form-control" minlength="3" required>
            </div>
            <button type="submit" class="btn">Update Profile</button>
        </form>
        <div class="header" style="margin-top: 30px;">
            <h2>Change Password</h2>
        </div>
        <form id="changePasswordForm">
            <div class="form-group">
                <label for="currentPassword">Current Password</label>
                <input type="password" id="currentPassword" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="changeNewPassword">New Password</label>
                <input type="password" id="changeNewPassword" class="form-control" minlength="8" required>
            </div>
            <div class="form-group">
                <label for="changeConfirmPassword">Confirm New Password</label>
                <input type="password" id="changeConfirmPassword" class="form-control" required>
            </div>
            <button type="submit" class="btn">Change Password</button>
        </form>
    </div>

    <script>
        // Configuration
        const API_URL = 'http://localhost:3000/api';

        // DOM Elements
        const containers = {
            home: document.getElementById('homeContainer'),
            login: document.getElementById('loginContainer'),
            register: document.getElementById('registerContainer'),
            resetRequest: document.getElementById('resetRequestContainer'),
            resetPassword: document.getElementById('resetPasswordContainer'),
            profile: document.getElementById('profileContainer'),
            verifyEmail: document.getElementById('verifyEmailContainer')
        };


        const forms = {
            login: document.getElementById('loginForm'),
            register: document.getElementById('registerForm'),
            resetRequest: document.getElementById('resetRequestForm'),
            resetPassword: document.getElementById('resetPasswordForm'),
            updateProfile: document.getElementById('updateProfileForm'),
            changePassword: document.getElementById('changePasswordForm')
        };

        const alerts = {
            login: document.getElementById('loginAlert'),
            register: document.getElementById('registerAlert'),
            resetRequest: document.getElementById('resetRequestAlert'),
            resetPassword: document.getElementById('resetPasswordAlert'),
            profile: document.getElementById('profileAlert'),
            verifyEmail: document.getElementById('verifyEmailAlert')
        };

        const navLinks = {
            home: document.getElementById('homeLink'),
            profile: document.getElementById('profileLink'),
            login: document.getElementById('loginLink'),
            register: document.getElementById('registerLink'),
            logout: document.getElementById('logoutLink')
        };

        // Navigation Links
        navLinks.home.addEventListener('click', showHome);
        navLinks.profile.addEventListener('click', showProfile);
        navLinks.login.addEventListener('click', showLogin);
        navLinks.register.addEventListener('click', showRegister);
        navLinks.logout.addEventListener('click', logout);

        // Form Links
        document.getElementById('goToRegister').addEventListener('click', showRegister);
        document.getElementById('goToLogin').addEventListener('click', showLogin);
        document.getElementById('goToResetRequest').addEventListener('click', showResetRequest);
        document.getElementById('backToLogin').addEventListener('click', showLogin);

        // Form Submissions
        forms.login.addEventListener('submit', handleLogin);
        forms.register.addEventListener('submit', handleRegister);
        forms.resetRequest.addEventListener('submit', handleResetRequest);
        forms.resetPassword.addEventListener('submit', handleResetPassword);
        forms.updateProfile.addEventListener('submit', handleUpdateProfile);
        forms.changePassword.addEventListener('submit', handleChangePassword);

        const verificationContainer = document.createElement('div');
        verificationContainer.className = 'container hidden';
        verificationContainer.id = 'verifyEmailContainer';
        verificationContainer.innerHTML = `
            <div class="header">
                <h1>Email Verification</h1>
                <p>Verifying your email address...</p>
            </div>
            <div id="verifyEmailAlert" class="alert hidden"></div>
        `;
        document.body.appendChild(verificationContainer);

        // Now, add them to the objects after definition
        containers.verifyEmail = verificationContainer;
        alerts.verifyEmail = document.getElementById('verifyEmailAlert');

        // Helper Functions
        function showContainer(containerId) {
            Object.values(containers).forEach(container => {
                container.classList.add('hidden');
            });
            containers[containerId].classList.remove('hidden');
        }

        function showAlert(alertId, message, type) {
            alerts[alertId].textContent = message;
            alerts[alertId].className = `alert alert-${type}`;
        }

        function hideAlert(alertId) {
            alerts[alertId].className = 'alert hidden';
        }

        function updateNavigation(isLoggedIn) {
            if (isLoggedIn) {
                navLinks.login.classList.add('hidden');
                navLinks.register.classList.add('hidden');
                navLinks.profile.classList.remove('hidden');
                navLinks.logout.classList.remove('hidden');
            } else {
                navLinks.login.classList.remove('hidden');
                navLinks.register.classList.remove('hidden');
                navLinks.profile.classList.add('hidden');
                navLinks.logout.classList.add('hidden');
            }
        }

        function getToken() {
            return localStorage.getItem('token');
        }

        function saveToken(token) {
            localStorage.setItem('token', token);
        }

        function removeToken() {
            localStorage.removeItem('token');
        }

        function saveUser(user) {
            localStorage.setItem('user', JSON.stringify(user));
        }

        function getUser() {
            const userData = localStorage.getItem('user');
            return userData ? JSON.parse(userData) : null;
        }

        function removeUser() {
            localStorage.removeItem('user');
        }

        // Page Functions
        function showHome() {
            showContainer('home');
        }

        function showLogin() {
            hideAlert('login');
            forms.login.reset();
            showContainer('login');
        }

        function showRegister() {
            hideAlert('register');
            forms.register.reset();
            showContainer('register');
        }

        function showResetRequest() {
            hideAlert('resetRequest');
            forms.resetRequest.reset();
            showContainer('resetRequest');
        }

        function showResetPassword(token) {
            hideAlert('resetPassword');
            forms.resetPassword.reset();
            document.getElementById('resetToken').value = token;
            showContainer('resetPassword');
        }

        function showProfile() {
            if (!getToken()) {
                showLogin();
                return;
            }
            
            fetchProfile();
            showContainer('profile');
        }

        // API Functions
        async function fetchWithAuth(url, options = {}) {
            const token = getToken();
            const headers = {
                'Content-Type': 'application/json',
                ...options.headers
            };
            
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }
            
            return fetch(url, {
                ...options,
                headers
            });
        }

        async function handleLogin(e) {
            e.preventDefault();
            hideAlert('login');
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                const response = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Login failed');
                }
                
                saveToken(data.token);
                saveUser(data.user);
                updateNavigation(true);
                showProfile();
                
            } catch (error) {
                showAlert('login', error.message, 'danger');
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            hideAlert('register');
            
            const username = document.getElementById('registerUsername').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('registerConfirmPassword').value;
            
            if (password !== confirmPassword) {
                showAlert('register', 'Passwords do not match', 'danger');
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, email, password })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || (data.errors && data.errors[0].msg) || 'Registration failed');
                }
                
                showAlert('register', data.message, 'success');
                setTimeout(() => {
                    showLogin();
                }, 3000);
                
            } catch (error) {
                showAlert('register', error.message, 'danger');
            }
        }

        async function handleResetRequest(e) {
            e.preventDefault();
            hideAlert('resetRequest');
            
            const email = document.getElementById('resetEmail').value;
            
            try {
                const response = await fetch(`${API_URL}/auth/reset-request`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Reset request failed');
                }
                
                showAlert('resetRequest', data.message, 'success');
                
            } catch (error) {
                showAlert('resetRequest', error.message, 'danger');
            }
        }

        async function handleResetPassword(e) {
            e.preventDefault();
            hideAlert('resetPassword');
            
            const token = document.getElementById('resetToken').value;
            const password = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmNewPassword').value;
            
            if (password !== confirmPassword) {
                showAlert('resetPassword', 'Passwords do not match', 'danger');
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/auth/reset-password`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ token, password })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Password reset failed');
                }
                
                showAlert('resetPassword', data.message, 'success');
                setTimeout(() => {
                    showLogin();
                }, 3000);
                
            } catch (error) {
                showAlert('resetPassword', error.message, 'danger');
            }
        }

        async function fetchProfile() {
            hideAlert('profile');
            
            try {
                const response = await fetchWithAuth(`${API_URL}/user/profile`);
                
                if (response.status === 401 || response.status === 403) {
                    removeToken();
                    removeUser();
                    updateNavigation(false);
                    showLogin();
                    throw new Error('Authentication failed. Please login again.');
                }
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to fetch profile');
                }
                
                const { user } = data;
                document.getElementById('profileUsername').textContent = user.username;
                document.getElementById('profileEmail').textContent = user.email;
                document.getElementById('profileCreatedAt').textContent = new Date(user.created_at).toLocaleDateString();
                document.getElementById('updateUsername').value = user.username;
                
            } catch (error) {
                showAlert('profile', error.message, 'danger');
            }
        }

        async function handleUpdateProfile(e) {
            e.preventDefault();
            hideAlert('profile');
            
            const username = document.getElementById('updateUsername').value;
            
            try {
                const response = await fetchWithAuth(`${API_URL}/user/profile`, {
                    method: 'PUT',
                    body: JSON.stringify({ username })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to update profile');
                }
                
                // Update local user data
                const user = getUser();
                if (user) {
                    user.username = username;
                    saveUser(user);
                }
                
                showAlert('profile', data.message, 'success');
                fetchProfile(); // Refresh profile data
                
            } catch (error) {
                showAlert('profile', error.message, 'danger');
            }
        }

        async function handleChangePassword(e) {
            e.preventDefault();
            hideAlert('profile');
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('changeNewPassword').value;
            const confirmPassword = document.getElementById('changeConfirmPassword').value;
            
            if (newPassword !== confirmPassword) {
                showAlert('profile', 'New passwords do not match', 'danger');
                return;
            }
            
            try {
                const response = await fetchWithAuth(`${API_URL}/user/change-password`, {
                    method: 'POST',
                    body: JSON.stringify({ currentPassword, newPassword })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to change password');
                }
                
                showAlert('profile', data.message, 'success');
                document.getElementById('changePasswordForm').reset();
                
            } catch (error) {
                showAlert('profile', error.message, 'danger');
            }
        }

        async function logout() {
            try {
                await fetchWithAuth(`${API_URL}/auth/logout`, {
                    method: 'POST'
                });
            } catch (error) {
                console.error('Logout error:', error);
            } finally {
                removeToken();
                removeUser();
                updateNavigation(false);
                showHome();
            }
        }

        async function verifyEmail(token) {
            try {
                const response = await fetch(`${API_URL}/auth/verify/${token}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Email verification failed');
                }
                
                showAlert('verifyEmail', data.message, 'success');
                setTimeout(() => {
                    showLogin();
                }, 3000);
                
            } catch (error) {
                showAlert('verifyEmail', error.message, 'danger');
            }
        }

        function init() {
            const token = getToken();
            const urlParams = new URLSearchParams(window.location.search);
            const action = urlParams.get('action');
            const queryToken = urlParams.get('token');
            
            // Check for email verification
            if (action === 'verify-email' && queryToken) {
                showContainer('verifyEmail');
                verifyEmail(queryToken);
                return;
            }
            
            // Check for password reset
            if (action === 'reset-password' && queryToken) {
                showResetPassword(queryToken);
                return;
            }
            
            // Regular login check
            if (token) {
                updateNavigation(true);
                showHome();
            } else {
                updateNavigation(false);
                showHome();
            }
        }
        // Initialize the app
        init();
    </script>
</body>
</html>